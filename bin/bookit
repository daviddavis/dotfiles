#!/usr/bin/env ruby

require "rubygems"
require "thor"

class Bookit < Thor
  default_task :split

  desc "convert [FILES] [OUTPUT]", "convert some FILES to an m4b file named OUTPUT"
  method_options stop_open: :string
  def combined(file_reg = "*.mp3", output = nil)
    output ||= File.basename(Dir.pwd)
    temp_mp3 = "temp#{Time.now.to_i}.mp3"

    say "Combining mp3s...", :green
    `cat #{file_reg} > #{temp_mp3}`

    say "Creating m4b file...", :green
    convert_mp3_to_m4b(temp_mp3, output)
    `rm #{temp_mp3}`

    open_with_itunes("#{output}.m4b") unless options[:stop_open]

    say "Done!", :green
  end

  desc "split", "convert all mp3s to m4b files with one m4b file per mp3"
  def split
    mp3s = Dir["*.mp3"]
    mp3s.each do |mp3|
      say "Creating a m4b for #{mp3}", :green
      m4b = convert_mp3_to_m4b(mp3)
      open_with_itunes(m4b)
    end
    say "Done!", :green
  end

  private

    def open_with_itunes(file)
      `open \"#{file}\"`
      stop_itunes
    end

    def stop_itunes
      `osascript -e 'tell application "iTunes"' -e "pause" -e "end tell" 2>/dev/null`
    end

    def convert_mp3_to_m4b(mp3, output = File.basename(mp3, ".mp3"))
      `ffmpeg -i \"#{mp3}\" -acodec libfaac \"#{output}.m4a\"`
      `mv \"#{output}.m4a\" \"#{output}.m4b\"`
      return "#{output}.m4b"
    end
end

Bookit.start